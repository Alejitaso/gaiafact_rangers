# .github/workflows/auto-review-pr.yml
# ‚ö†Ô∏è IMPORTANTE: Este archivo debe estar SOLO en la rama main
# ‚ö†Ô∏è NO debe existir en la rama dev por seguridad

name: Auto Review Pull Request

# Se ejecuta cuando hay push a dev, pero el workflow est√° en main
on:
  push:
    branches: 
      - dev

jobs:
  create-review-pr:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Necesario para comparar commits
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Get commit info
      id: commit_info
      run: |
        COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s')
        COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')
        COMMIT_HASH=$(git log -1 --pretty=format:'%h')
        echo "message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
        echo "author=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT  
        echo "hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
    
    - name: Create temporary branch for review
      run: |
        BRANCH_NAME="review/dev-$(date +%Y%m%d-%H%M%S)-${{ steps.commit_info.outputs.hash }}"
        git checkout -b $BRANCH_NAME
        git push origin $BRANCH_NAME
        echo "REVIEW_BRANCH=$BRANCH_NAME" >> $GITHUB_ENV
    
    - name: Reset dev to previous commit
      run: |
        git checkout dev
        git reset --hard HEAD~1
        git push --force origin dev
    
    - name: Create Pull Request for Review
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        title: "üîç Review Required: ${{ steps.commit_info.outputs.message }}"
        body: |
          ## Cambios pendientes de revisi√≥n
          
          **Autor:** ${{ steps.commit_info.outputs.author }}
          **Commit:** ${{ steps.commit_info.outputs.hash }}
          **Mensaje original:** ${{ steps.commit_info.outputs.message }}
          
          ---
          
          ### ‚ö†Ô∏è Este PR fue creado autom√°ticamente
          
          Los cambios fueron enviados via `git push origin dev` y est√°n esperando aprobaci√≥n.
          
          **Para aprobar:**
          - ‚úÖ Revisar los cambios
          - ‚úÖ Aprobar este PR  
          - ‚úÖ Hacer merge para integrar a dev
          
          **Para rechazar:**
          - ‚ùå Cerrar este PR sin hacer merge
          - ‚ùå Los cambios se perder√°n
          
        branch: ${{ env.REVIEW_BRANCH }}
        base: dev
        draft: false
        reviewers: |
          Alejitaso
          liss
        assignees: |
          Alejitaso
          liss
